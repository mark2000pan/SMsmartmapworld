<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>Automatická Navigácia</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; }
        #map { height: 100vh; width: 100%; }
        
        /* Schováme zbytočné textové pokyny, aby zostala len mapa a vyhľadávač */
        .leaflet-routing-container { 
            max-height: 150px !important; 
            overflow-y: auto; 
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        // 1. Nastavenie mapy
        var map = L.map('map').setView([48.66, 19.50], 7);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap',
            noWrap: true
        }).addTo(map);

        // 2. Inicializácia navigácie
        var routingControl = L.Routing.control({
            waypoints: [
                null, // Tu bude tvoja poloha (Bod A)
                null  // Sem budeš písať cieľ (Bod B)
            ],
            geocoder: L.Control.Geocoder.nominatim(),
            routeWhileDragging: true,
            language: 'sk',
            addWaypoints: false, // Nedovolíme pridávať ďalšie body, len A a B
            collapsible: false
        }).addTo(map);

        // 3. Funkcia na snímanie tvojej polohy
        function aktualizujPolohu() {
            map.locate({
                setView: false, // Nechceme, aby mapa skákala každú sekundu
                watch: true,    // "Sleduje" tvoj pohyb
                enableHighAccuracy: true
            });
        }

        // Keď systém nájde tvoju polohu
        map.on('locationfound', function(e) {
            // Ak ešte nemáme cieľ, vycentrujeme mapu na teba
            if (!routingControl.getWaypoints()[1].latLng) {
                map.setView(e.latlng, 14);
            }

            // VŽDY nastavíme tvoju aktuálnu polohu ako Bod A
            routingControl.spliceWaypoints(0, 1, e.latlng);

            // Pridáme/aktualizujeme tvoju značku na mape
            if (window.myLocationMarker) {
                window.myLocationMarker.setLatLng(e.latlng);
            } else {
                window.myLocationMarker = L.circleMarker(e.latlng, {
                    radius: 8, color: 'white', fillColor: '#007bff', fillOpacity: 1, weight: 2
                }).addTo(map).bindPopup("Ty si tu");
            }
        });

        map.on('locationerror', function() {
            console.log("Nepodarilo sa získať polohu. Skontroluj GPS.");
        });

        // Spustíme sledovanie
        aktualizujPolohu();

    </script>
</body>
</html>
